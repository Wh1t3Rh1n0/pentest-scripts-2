#!/bin/bash

if [ "$1" != "go" ] ; then
cat <<EOF

extract-everything.sh
=====================

Extracts all the archives stored in all subdirectories in an organized way.
Good for extracting bulk data before further analysis.

The process used for extraction is:

1. Find all the archive files in all subdirectories of the current directory.

2. For every archive that is found:

    i. Create a folder in the same location as the archive, named
       <ARCHIVE FILENAME>.extracted.

    ii. Extract all the contents of the archive into the created folder.

    iii. Delete the original archive.

Usage: From *inside* the target folder, call this script with the
       argument, "go".

Extra options: "go --keep" will keep the original archive instead of deleting
               it after extraction.

Example:    cd ./data/
            bash ../extract-everything.sh go --keep
EOF
    exit
fi

enable_keep="$3"

IFS=$(echo -en "\n\b")
start_dir="$PWD"

check_tool() {
    if [ "$(which $1)" == "" ] ; then
        echo "Error: Could not find '$1' command, which is required by this script."
        exit
    fi
}

bulk_extract() {
    for f in $* ; do
        out_dir="$f.extracted"
        mkdir "$out_dir"
        cd "$out_dir"

        file_ext=$(echo "$f" | grep --color=never -Eio '\.[a-z0-9.]{1,6}$' | tr '[:upper:]' '[:lower:]')

        if [ "$file_ext" == ".tar.gz" ] ; then
            tar -xzvf "$f"
        elif [ "$file_ext" == ".tar.xz" ] ; then
            tar -xJvf "$f"
        elif [ "$file_ext" == ".tar.bz2" ] ; then
            tar -xjvf "$f"
        elif [ "$file_ext" == ".zip" ] ; then
            7z x "$f"
        elif [ "$file_ext" == ".jar" ] ; then
            7z x "$f"
        elif [ "$file_ext" == ".7z" ] ; then
            7z x "$f"
        elif [ "$file_ext" == ".rar" ] ; then
            unrar e "$f"
        elif [ "$file_ext" == ".gz" ] ; then
            gzip -d -c "$f" > "$out_dir/data"
        elif [ "$file_ext" == ".xz" ] ; then
            xz -d -c "$f" > "$out_dir/data"
        elif [ "$file_ext" == ".bz2" ] ; then
            bzip2 -d -c "$f" > "$out_dir/data"
        fi

        echo cd "$start_dir"

        if [ "$enable_keep" != "--keep" ] ; then
            rm -fv "$f"
        fi

    done
}

check_tool tar
check_tool 7z
check_tool gzip
check_tool unrar
check_tool xz
check_tool bzip2

bulk_extract `find "$PWD" -type f \( -iname "*.tar.gz" -or -iname "*.tgz" \)`

bulk_extract `find "$PWD" -type f -iname "*.tar.xz"`

bulk_extract `find "$PWD" -type f -iname "*.tar.bz2"`

bulk_extract `find "$PWD" -type f -iname "*.zip"`

bulk_extract `find "$PWD" -type f -iname "*.jar"`

bulk_extract `find "$PWD" -type f -iname "*.7z"`

bulk_extract `find "$PWD" -type f -iname "*.rar"`

bulk_extract `find "$PWD" -type f -iname "*.gz"`

bulk_extract `find "$PWD" -type f -iname "*.xz"`

bulk_extract `find "$PWD" -type f -iname "*.bz2"`

bulk_extract `find "$PWD" -type f -iname "*.bz2"`

echo "DONE!"
