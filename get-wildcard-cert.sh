#!/bin/bash

if [ "$1" == "--help" ] || [ "$1" == "-h" ] || [ "$1" == "" ] ; then
    echo
    echo "LetsEncrypt wildcard certificate requester"
    echo "------------------------------------------"
    echo "Requests a wildcard certificate from LetsEncrypt for the given domain."
    echo
    echo "Requires the 'letsencrypt' command to be installed."
    echo "- Will automatically attempt to install the command with"
    echo "  'apt install -y certbot' if letsencrypt is not found."
    echo
    echo "Usage: $0 <domain>"
    echo
    exit
fi

if [ "$(which letsencrypt)" == "" ] ; then
    echo "'letsencrypt' command not found."
    echo "Attempting to automatically install with 'apt install certbot'..."
    sudo apt update
    sudo apt install -y certbot
fi
if [ "$(which letsencrypt)" == "" ] ; then
    echo "Still cannot find 'letsencrypt' command."
    echo "Quitting."
    exit
fi

domain=$1

sudo letsencrypt certonly --server https://acme-v02.api.letsencrypt.org/directory \
    --manual \
    --preferred-challenges dns \
    --register-unsafely-without-email \
    -d "*.$domain"

echo "Done!"
