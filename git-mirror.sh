#!/bin/bash

outdir='git-mirror-output'

AGENT='Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36 Edg/122.0.0.0'

if [ "$1" == "" ] || [ "$1" == "--help" ] || [ "$1" == "-h" ] ; then
    echo
    echo "git-mirror.sh"
    echo "-------------"
    echo "A simple script to quickly clone all the repositories owned by one"
    echo "or more GitHub user and/or organization accounts."
    echo
    echo "Requires git to be installed."
    echo
    echo "Separate folders for each user and repo are created in the output"
    echo "directory: ./$outdir/"
    echo
    echo "Usage: bash $0 <LIST OF GITHUB USER/ORG ACCOUNT NAMES>"
    echo
    echo "Example: bash $0 targets.txt"
    echo
	exit
fi

for account in $(cat "$1") ; do
    echo "Attempting to mirror GitHub account: $account"
    mkdir -p "$outdir/$account"
    cd "$outdir/$account"
    for url in $( ( curl -A "$AGENT" -s "https://api.github.com/orgs/$account/repos?per_page=200" ; curl -A "$AGENT" -s "https://api.github.com/users/$account/repos?per_page=200" ) | grep html_url | sed -E 's/^[[:space:]]*//g' | sort -u | cut -d '"' -f 4 ); do
        git clone $url
    done
    cd ../..
    echo "-----"
done
