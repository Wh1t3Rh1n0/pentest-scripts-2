#!/bin/bash

##
## nessus-csv2ip.sh
## ----------------
## Converts a Nessus exported CSV file to a colon-separated list of IPs and ports.
##
## Outputs to stdout.
##
## Usage: ./nessus-csv2ip.sh <CSV FILE> [--udp] > <OUTPUT FILE>
##
## Requires: grep, awk, sort
##
## The script displays TCP ports by default. Add the "--udp" option to output
## UDP ports instead.
##

if [ "$1" == "" ] || [ "$1" == "--help" ] || [ "$1" == "-h" ] ; then
    grep -E '^## ?' "$0" | sed -E 's/^## ?//g'
    exit
fi

CSV_FILE=$1

sort_unique_ipport() {
    tr ':' '.' | sort -u -n -t . -k 1,1 -k 2,2 -k 3,3 -k 4,4 -k 5,5 | awk -F '.' '{ print $1 "." $2 "." $3 "." $4 ":" $5 }'
}


if [ "$2" == "--udp" ] ; then
    grep -iE '^"[0-9].+,"udp","[1-9][0-9]*",' "$CSV_FILE" | awk -F '"' '{print $10 ":" $14}' | sort_unique_ipport
else
    grep -iE '^"[0-9].+,"tcp","[1-9][0-9]*",' "$CSV_FILE" | awk -F '"' '{print $10 ":" $14}' | sort_unique_ipport
fi
