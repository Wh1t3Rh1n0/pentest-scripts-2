#!/bin/bash

if [ "$1" == "" ] || [ "$1" == "--help" ] || [ "$1" == "-h" ] ; then
    echo
    echo "s3-bucket-check.sh"
    echo "------------------"
    echo "A simple script to quickly test an Amazon AWS S3 bucket for read and"
    echo "write access. If read access is allowed, the script automatically"
    echo "attempts to download all contents of the S3 bucket."
    echo
    echo "Requires the awscli tools to be installed."
    echo
    echo "Note that the bucket name should be the bucket name only and not"
    echo "include .s3.amazonaws.com."
    echo
	echo "Usage: bash $0 <BUCKET> [--no-download]"
    echo
    echo "Example: bash $0 acmebucket"
    echo
	exit
fi

if [ "$(which aws)" == "" ] ; then
    echo "Error: Could not find the `aws` command."
    echo "Attempting to automatically install..."
    sudo apt update
    sudo apt install -y awscli
    echo "If `awscli` installed successfully, try running this script again."
    exit
fi


if [ ! -e "$HOME/.aws/credentials" ] ; then
	echo "Run 'aws configure' and import your credentials first."
	exit
fi

BUCKET=$1



echo Testing read access to $BUCKET...
aws s3 ls s3://$BUCKET/

echo
echo Testing write access to $BUCKET...
echo test > test.txt
aws s3 mv test.txt s3://$BUCKET/

if [ ! "$2" == "--no-download" ] ; then
    echo
    echo Attempting to sync to ./$BUCKET/...
    mkdir $BUCKET
    aws s3 sync s3://$BUCKET/ ./$BUCKET
fi

echo
echo DONE
