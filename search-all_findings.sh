#!/bin/bash

if [ "$2" == "" ] ; then
    cat <<EOF

search-all_findings.sh
======================
Search the CSV file output by 'nessus-all_findings.sh' for lines that match
the regex. Search is case insensitive.

Outputs are:
- STDERR: Raw search results, showing full matching lines.
- STDOUT: IP:Port formatted list of matching hosts, sorted and uniqued.

Optional arguments are:
--noports   : STDOUT outputs IP addresses only instead of IP:Port

Usage: search-all_findings.sh <CSV FILE> <REGEX SEARCH QUERY> [OPTIONS]

Example:

./search-all_findings.sh all_findings.csv 'smb signing' --noports > targets.txt
EOF
    exit
fi

grep --color -iE "$2" "$1" 1>&2
echo 1>&2

sort_unique_ipport() {
    tr ':' '.' | sort -u -n -t . -k 1,1 -k 2,2 -k 3,3 -k 4,4 -k 5,5 | awk -F '.' '{ print $1 "." $2 "." $3 "." $4 ":" $5 }'
}


if [ "$3" == "" ] ; then
    grep --color=never -iE "$2" "$1" | cut -d ';' -f 4,5 | tr ';' ':' | sort_unique_ipport
elif [ "$3" == "--noports" ] ; then
    grep --color=never -iE "$2" "$1" | cut -d ';' -f 4 | sort_unique_ipport
fi
